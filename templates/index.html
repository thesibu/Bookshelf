<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Book Recommender System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #F9F6F1;
      --text-color: #3E2C41;
      --card-bg: #FFFFFF;
    }
    body {
      background-color: var(--bg-color);
      font-family: 'Inter', sans-serif;
      transition: background-color 0.3s ease;
    }
    .dark-mode {
      --bg-color: #1E1E2F;
      --text-color: #F9F6F1;
      --card-bg: #2C2C3E;
    }
    .navbar { background: #3E2C41; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-bottom: 1px solid #D4AF37; padding: 12px 24px; }
    .navbar-brand { font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #D4AF37 !important; }
    .navbar-nav .nav-link { color: #F9F6F1 !important; font-weight: 500; margin-right: 20px; transition: color 0.3s ease; }
    .navbar-nav .nav-link:hover { color: #D4AF37 !important; }
    .toggle-btn { background-color: #D4AF37; color: #3E2C41; border: none; padding: 6px 14px; border-radius: 6px; font-weight: 500; transition: background-color 0.3s ease; }
    .toggle-btn:hover { background-color: #bfa032; }
    .heading { margin: 40px 0 20px 20px; color: var(--text-color); font-size: 38px; font-family: 'Playfair Display', serif; font-weight: 600; border-left: 6px solid #D4AF37; padding-left: 15px; }
    .book-card { background-color: var(--card-bg); border: 1px solid #E0E0E0; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; height: 460px; display: flex; flex-direction: column; justify-content: space-between; }
    .book-card:hover { transform: translateY(-6px); box-shadow: 0 10px 24px rgba(0,0,0,0.15); }
    .book-img { width: 100%; max-height: 200px; object-fit: contain; border-top-left-radius: 12px; border-top-right-radius: 12px; background-color: #F4F4F4; padding: 10px; }
    .card-body { padding: 20px; }
    .book-title { color: var(--text-color); font-size: 18px; font-weight: 600; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .book-author { color: #6C5B7B; font-size: 15px; margin-bottom: 10px; }
    .rating { color: #D4AF37; font-size: 14px; font-weight: 500; }
    .save-btn { margin-top: 10px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üìö BookNest</a>
      <button class="navbar-toggler text-light" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="/wishlist/view"><i class="fas fa-heart"></i> Wishlist</a></li>
          <li class="nav-item"><a class="nav-link" href="/"><i class="fas fa-home"></i>Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/marketplace"><i class="fas fa-store"></i>Marketplace</a></li>
          <li class="nav-item"><a class="nav-link" href="/recommend"><i class="fas fa-book-open"></i>Recommend</a></li>
          <li class="nav-item"><a class="nav-link" href="/contact"><i class="fas fa-envelope"></i>Contact</a></li>
          <li class="nav-item"><button class="toggle-btn ms-3" onclick="toggleDarkMode()">üåì Toggle Mode</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="filter-bar d-flex justify-content-between align-items-center mt-4">
      <div class="heading">Top 50 Books</div>
      <select class="form-select w-auto" onchange="location.href='/genre/' + this.value">
        <option selected disabled>Filter by Genre</option>
        <option value="fiction">Fiction</option>
        <option value="non-fiction">Non-Fiction</option>
        <option value="fantasy">Fantasy</option>
        <option value="mystery">Mystery</option>
      </select>
    </div>

    <div class="row g-4" id="booksGrid">
      {% for i in range(book_name|length) %}
      <div class="col-sm-6 col-md-4 col-lg-3" data-aos="fade-up" data-aos-delay="{{ i*50 }}">
        <div class="card book-card">
          <img class="book-img" src="{{ images[i] }}" alt="Book Cover">
          <div class="card-body">
            <div class="book-title">{{ book_name[i] }}</div>
            <div class="book-author">{{ author[i] }}</div>
            <div class="rating">‚≠ê Ratings: {{ ratings[i] }}</div>
            <div class="rating">üó≥Ô∏è Votes: {{ votes[i] }}</div>
            <button
              type="button"
              class="btn btn-outline-primary mt-2 save-btn"
              data-name="{{ book_name[i]|e }}"
              data-author="{{ author[i]|e }}"
              data-image="{{ images[i]|e }}"
              data-rating="{{ ratings[i]|default('') }}"
              data-votes="{{ votes[i]|default('') }}"
            >Save</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({ duration: 800, once: true });

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }

    function normalize(s) { return (s || '').toString().trim().toLowerCase(); }

    async function markSavedButtons() {
      try {
        const res = await fetch('/wishlist');
        const data = await res.json();
        const saved = (data.wishlist || []).map(b => normalize(b.name));
        document.querySelectorAll('.save-btn').forEach(btn => {
          const name = normalize(btn.dataset.name);
          if (saved.includes(name)) {
            btn.textContent = 'Saved';
            btn.disabled = true;
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
          }
        });
      } catch (err) {
        console.error('Could not load wishlist:', err);
      }
    }

    function attachSaveListeners() {
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const payload = {
            name: btn.dataset.name,
            author: btn.dataset.author,
            image: btn.dataset.image,
            rating: btn.dataset.rating,
            votes: btn.dataset.votes
          };

          try {
            const res = await fetch('/wishlist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data.status === 'success' || data.status === 'exists') {
              btn.textContent = 'Saved';
              btn.disabled = true;
              btn.classList.remove('btn-outline-primary');
              btn.classList.add('btn-success');
              const msg = data.status === 'success' ? 'added to' : 'already in';
              alert(`üìå "${payload.name}" ${msg} your wishlist! (Total: ${data.wishlist_count})`);
            } else {
              alert('Error saving book.');
              console.error(data);
            }
          } catch (err) {
            alert('Network error while saving. Check console.');
            console.error(err);
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      attachSaveListeners();
      markSavedButtons();
    });
  </script>
</body>
</html>
